# Deploy Echo Web Chat UI to Cloud Run Staging
#
# This workflow builds, pushes to Artifact Registry, and deploys to Cloud Run.
# Uses Workload Identity Federation (OIDC) - no stored cloud credentials.
#
# Triggers:
#   - Push to main (when web app files change)
#   - Manual trigger (workflow_dispatch)

name: Deploy Web to Cloud Run (Staging)

on:
  push:
    branches: [main]
    paths:
      - "apps/web/**"
      - ".github/workflows/web_deploy_staging.yml"
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "Force deploy even if no changes"
        type: boolean
        default: true

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: europe-west1
  GAR_REPO: echo-web
  CLOUD_RUN_SERVICE: echo-web-staging

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run typecheck

      - name: Run tests
        run: npm run test

  deploy:
    name: Build & Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: lint-and-test

    # Skip entirely if project not configured (first-time setup)
    if: ${{ vars.GCP_PROJECT_ID != '' }}

    permissions:
      contents: read
      id-token: write # Required for OIDC token request

    steps:
      - name: Preflight - Check required GitHub Variables
        run: |
          echo "====================================="
          echo "  üîç PREFLIGHT: Checking Variables  "
          echo "====================================="
          
          missing=0
          
          if [ -z "${{ vars.GCP_PROJECT_ID }}" ]; then
            echo "‚ùå GCP_PROJECT_ID (REQUIRED) - NOT SET"
            missing=$((missing + 1))
          else
            echo "‚úÖ GCP_PROJECT_ID = ${{ vars.GCP_PROJECT_ID }}"
          fi
          
          if [ -z "${{ vars.GCP_WIF_PROVIDER }}" ]; then
            echo "‚ùå GCP_WIF_PROVIDER (REQUIRED) - NOT SET"
            missing=$((missing + 1))
          else
            echo "‚úÖ GCP_WIF_PROVIDER = ${{ vars.GCP_WIF_PROVIDER }}"
          fi
          
          if [ -z "${{ vars.GCP_SERVICE_ACCOUNT }}" ]; then
            echo "‚ùå GCP_SERVICE_ACCOUNT (REQUIRED) - NOT SET"
            missing=$((missing + 1))
          else
            echo "‚úÖ GCP_SERVICE_ACCOUNT = ${{ vars.GCP_SERVICE_ACCOUNT }}"
          fi
          
          if [ $missing -gt 0 ]; then
            echo "====================================="
            echo "  ‚ùå PREFLIGHT FAILED: $missing missing"
            echo "====================================="
            exit 1
          fi
          
          echo "====================================="
          echo "  ‚úÖ PREFLIGHT PASSED              "
          echo "====================================="

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and push image to Artifact Registry
        id: build
        run: |
          IMAGE_BASE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/echo-web"
          IMAGE_SHA="${IMAGE_BASE}:${{ github.sha }}"
          IMAGE_LATEST="${IMAGE_BASE}:staging-latest"
          
          echo "Building image: $IMAGE_SHA"
          
          docker build \
            -t "$IMAGE_SHA" \
            -t "$IMAGE_LATEST" \
            -f apps/web/Dockerfile \
            apps/web
          
          echo "Pushing to Artifact Registry..."
          docker push "$IMAGE_SHA"
          docker push "$IMAGE_LATEST"
          
          echo "image=$IMAGE_SHA" >> $GITHUB_OUTPUT
          echo "‚úÖ Image pushed: $IMAGE_SHA"

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.CLOUD_RUN_SERVICE }}
          region: ${{ env.GCP_REGION }}
          image: ${{ steps.build.outputs.image }}
          flags: "--allow-unauthenticated --port=8080"
          env_vars: |
            APP_ENV=staging

      - name: Show deployment info
        run: |
          echo "‚úÖ Deployment successful!"
          echo ""
          echo "Service URL: ${{ steps.deploy.outputs.url }}"
          echo "Image: ${{ steps.build.outputs.image }}"

      - name: Post-deploy smoke test
        run: |
          SERVICE_URL="${{ steps.deploy.outputs.url }}"
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          echo "Waiting 15s for service to stabilize..."
          sleep 15
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/" --connect-timeout 10 --max-time 30 || echo "000")
            
            if [ "$STATUS" = "200" ]; then
              echo ""
              echo "====================================="
              echo "  ‚úÖ SMOKE TEST PASSED (HTTP 200)   "
              echo "====================================="
              echo ""
              echo "Web UI is live at: $SERVICE_URL"
              exit 0
            fi
            
            echo "  Got HTTP $STATUS, retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done
          
          echo ""
          echo "====================================="
          echo "  ‚ùå SMOKE TEST FAILED               "
          echo "====================================="
          exit 1
