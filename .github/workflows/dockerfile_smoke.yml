# Dockerfile Smoke Test
#
# Validates Dockerfile syntax and early build stages before Cloud Build runs.
# This catches "Dockerfile not found" and COPY path errors early in PRs.
# Does NOT push images - just validates the build can start.

name: Dockerfile Smoke

on:
  pull_request:
    branches: [main]
    paths:
      - "Dockerfile"
      - ".dockerignore"
      - "services/echo_backend/Dockerfile"
      - "services/echo_backend/.dockerignore"
      - "services/echo_backend/requirements.txt"

jobs:
  smoke:
    name: Dockerfile Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate root Dockerfile exists
        run: |
          if [ ! -f Dockerfile ]; then
            echo "❌ ERROR: Root Dockerfile not found!"
            echo "Cloud Run 'Deploy from repository' requires ./Dockerfile at repo root."
            exit 1
          fi
          echo "✅ Root Dockerfile exists"

      - name: Lint Dockerfile (hadolint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: error

      - name: Validate COPY paths exist
        run: |
          echo "Checking paths referenced in Dockerfile..."
          
          # Check services/echo_backend exists
          if [ ! -d "services/echo_backend" ]; then
            echo "❌ ERROR: services/echo_backend/ directory not found"
            exit 1
          fi
          echo "✅ services/echo_backend/ exists"
          
          # Check requirements.txt exists
          if [ ! -f "services/echo_backend/requirements.txt" ]; then
            echo "❌ ERROR: services/echo_backend/requirements.txt not found"
            exit 1
          fi
          echo "✅ requirements.txt exists"

      - name: Dry-run build (syntax only)
        run: |
          # Just parse the Dockerfile, don't actually build (too slow)
          docker build --help > /dev/null
          echo "✅ Docker available"
          echo "ℹ️  Full build runs in Cloud Build, not here (too resource-intensive)"
