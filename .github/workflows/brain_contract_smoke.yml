name: Brain API Contract Smoke

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  brain-contract-smoke:
    name: Brain API Contract Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/echo_backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            services/echo_backend/requirements.txt
            services/echo_backend/requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start backend server (stub mode)
        run: |
          export ECHO_BRAIN_PROVIDER=stub
          export ECHO_DISABLE_MODEL_DOWNLOADS=1
          export ECHO_REQUIRE_SECRETS=0
          uvicorn main:app --host 127.0.0.1 --port 8000 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          
          # Wait for server to be ready (max 30s)
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:8000/healthz > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Server failed to start within 30 seconds"
              exit 1
            fi
            sleep 1
          done

      - name: Contract Test - Health Endpoint
        run: |
          echo "Testing GET /v1/brain/health..."
          RESPONSE=$(curl -s http://127.0.0.1:8000/v1/brain/health)
          echo "Response: $RESPONSE"
          
          # Validate response structure
          echo "$RESPONSE" | jq -e '.ok == true' || { echo "Health check failed: ok != true"; exit 1; }
          echo "$RESPONSE" | jq -e '.version' || { echo "Health check failed: missing version"; exit 1; }
          echo "$RESPONSE" | jq -e '.provider == "stub"' || { echo "Health check failed: provider != stub"; exit 1; }
          
          echo "✓ Health endpoint contract validated"

      - name: Contract Test - Chat Endpoint
        run: |
          echo "Testing POST /v1/brain/chat..."
          RESPONSE=$(curl -s -X POST http://127.0.0.1:8000/v1/brain/chat \
            -H "Content-Type: application/json" \
            -d '{"messages":[{"role":"user","content":"Test message"}]}')
          echo "Response: $RESPONSE"
          
          # Validate response structure
          echo "$RESPONSE" | jq -e '.session_id' || { echo "Chat failed: missing session_id"; exit 1; }
          echo "$RESPONSE" | jq -e '.message.role == "assistant"' || { echo "Chat failed: message.role != assistant"; exit 1; }
          echo "$RESPONSE" | jq -e '.message.content' || { echo "Chat failed: missing message.content"; exit 1; }
          echo "$RESPONSE" | jq -e '.usage.total_tokens' || { echo "Chat failed: missing usage.total_tokens"; exit 1; }
          
          # Validate stub response contains expected text
          CONTENT=$(echo "$RESPONSE" | jq -r '.message.content')
          if [[ ! "$CONTENT" =~ "stub" ]]; then
            echo "Chat failed: response doesn't contain 'stub'"
            exit 1
          fi
          
          echo "✓ Chat endpoint contract validated"

      - name: Contract Test - Streaming Endpoint
        run: |
          echo "Testing POST /v1/brain/chat/stream..."
          STREAM_OUTPUT=$(timeout 10s curl -s -X POST http://127.0.0.1:8000/v1/brain/chat/stream \
            -H "Content-Type: application/json" \
            -d '{"messages":[{"role":"user","content":"Stream test"}]}' || true)
          
          echo "Stream output (first 500 chars):"
          echo "$STREAM_OUTPUT" | head -c 500
          
          # Validate SSE format
          if [[ ! "$STREAM_OUTPUT" =~ "event: token" ]]; then
            echo "Stream failed: missing 'event: token'"
            exit 1
          fi
          
          if [[ ! "$STREAM_OUTPUT" =~ "event: final" ]]; then
            echo "Stream failed: missing 'event: final'"
            exit 1
          fi
          
          if [[ ! "$STREAM_OUTPUT" =~ "data:" ]]; then
            echo "Stream failed: missing 'data:' lines"
            exit 1
          fi
          
          # Validate final event contains required fields
          if [[ ! "$STREAM_OUTPUT" =~ "session_id" ]]; then
            echo "Stream failed: final event missing session_id"
            exit 1
          fi
          
          echo "✓ Streaming endpoint contract validated"

      - name: Shutdown server
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            echo "Stopping server (PID: $SERVER_PID)..."
            kill $SERVER_PID || true
            wait $SERVER_PID 2>/dev/null || true
          fi
