# Deploy echo-backend to Cloud Run Staging
#
# This workflow builds, pushes to Artifact Registry, and deploys to Cloud Run.
# Uses Workload Identity Federation (OIDC) - no stored cloud credentials.
#
# Triggers:
#   - Push to main (when backend files change)
#   - Manual trigger (workflow_dispatch)

name: Deploy Backend to Cloud Run (Staging)

on:
  push:
    branches: [main]
    paths:
      - "services/echo_backend/**"
      - "Dockerfile"
      - ".dockerignore"
      - ".github/workflows/backend_cloudrun_staging.yml"
      - "docs/ops/**"
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "Force deploy even if no changes"
        type: boolean
        default: true

env:
  # These are read from GitHub Repository Variables (Settings ‚Üí Variables)
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION || 'us-east1' }}
  GAR_REPO: ${{ vars.GAR_REPO || 'echo' }}
  CLOUD_RUN_SERVICE: ${{ vars.CLOUD_RUN_SERVICE || 'echo-backend-staging' }}

jobs:
  deploy:
    name: Build & Deploy to Cloud Run
    runs-on: ubuntu-latest

    # Skip entirely if project not configured (first-time setup)
    if: ${{ vars.GCP_PROJECT_ID != '' }}

    permissions:
      contents: read
      id-token: write  # Required for OIDC token request

    steps:
      - name: Preflight - Check required GitHub Variables
        id: preflight
        run: |
          echo "====================================="
          echo "  üîç PREFLIGHT: Checking Variables  "
          echo "====================================="
          echo ""

          # Track missing variables
          missing=0

          check_var() {
            local name="$1"
            local value="$2"
            local required="$3"
            local where="$4"

            if [ -z "$value" ]; then
              if [ "$required" = "yes" ]; then
                echo "‚ùå $name (REQUIRED) - NOT SET"
                echo "   Where to find: $where"
                missing=$((missing + 1))
              else
                echo "‚ö™ $name (optional) - not set, will use default"
              fi
            else
              echo "‚úÖ $name = $value"
            fi
          }

          echo "Required variables:"
          echo "-------------------"
          check_var "GCP_PROJECT_ID" "${{ vars.GCP_PROJECT_ID }}" "yes" "GCP Console ‚Üí Project selector (top-left)"
          check_var "GCP_WIF_PROVIDER" "${{ vars.GCP_WIF_PROVIDER }}" "yes" "GCP ‚Üí IAM ‚Üí Workload Identity Federation ‚Üí Pool ‚Üí Provider"
          check_var "GCP_SERVICE_ACCOUNT" "${{ vars.GCP_SERVICE_ACCOUNT }}" "yes" "GCP ‚Üí IAM ‚Üí Service Accounts ‚Üí email column"
          echo ""
          echo "Optional variables (have defaults):"
          echo "-----------------------------------"
          check_var "GCP_REGION" "${{ vars.GCP_REGION }}" "no" "Default: us-east1"
          check_var "GAR_REPO" "${{ vars.GAR_REPO }}" "no" "Default: echo"
          check_var "CLOUD_RUN_SERVICE" "${{ vars.CLOUD_RUN_SERVICE }}" "no" "Default: echo-backend-staging"
          echo ""

          if [ $missing -gt 0 ]; then
            echo "====================================="
            echo "  ‚ùå PREFLIGHT FAILED: $missing missing"
            echo "====================================="
            echo ""
            echo "üìù To fix, go to GitHub:"
            echo "   Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables tab"
            echo ""
            echo "üìñ Full setup guide:"
            echo "   docs/ops/gcp_staging_cloudrun_setup.md"
            echo ""
            echo "üìã Quick variable reference:"
            echo "   docs/ops/github_variables_for_staging.md"
            exit 1
          fi

          echo "====================================="
          echo "  ‚úÖ PREFLIGHT PASSED              "
          echo "====================================="

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker system prune -af
          df -h

      - name: Authenticate to Google Cloud (OIDC)
        id: auth
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Compute build timestamp
        id: buildtime
        run: |
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "Build time: $BUILD_TIME"

      - name: Build and push image to Artifact Registry
        id: build
        run: |
          IMAGE_BASE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/echo-backend"
          IMAGE_SHA="${IMAGE_BASE}:${{ github.sha }}"
          IMAGE_LATEST="${IMAGE_BASE}:staging-latest"
          
          echo "Building image: $IMAGE_SHA"
          
          docker build \
            -t "$IMAGE_SHA" \
            -t "$IMAGE_LATEST" \
            -f Dockerfile \
            .
          
          echo "Pushing to Artifact Registry..."
          docker push "$IMAGE_SHA"
          docker push "$IMAGE_LATEST"
          
          echo "image=$IMAGE_SHA" >> $GITHUB_OUTPUT
          echo "‚úÖ Image pushed: $IMAGE_SHA"

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.CLOUD_RUN_SERVICE }}
          region: ${{ env.GCP_REGION }}
          image: ${{ steps.build.outputs.image }}
          flags: '--allow-unauthenticated'
          env_vars: |
            APP_ENV=staging
            GIT_SHA=${{ github.sha }}
            BUILD_TIME=${{ steps.buildtime.outputs.build_time }}

      - name: Show deployment info
        run: |
          echo "‚úÖ Deployment successful!"
          echo ""
          echo "Service URL: ${{ steps.deploy.outputs.url }}"
          echo "Image: ${{ steps.build.outputs.image }}"
          echo ""
          echo "Test endpoints:"
          echo "  Health: ${{ steps.deploy.outputs.url }}/health"
          echo "  API Docs: ${{ steps.deploy.outputs.url }}/docs"

      - name: Post-deploy smoke test (/health)
        run: |
          SERVICE_URL="${{ steps.deploy.outputs.url }}"
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          echo "====================================="
          echo "  üî• POST-DEPLOY SMOKE TEST         "
          echo "====================================="
          echo "Service URL: $SERVICE_URL"
          echo "Endpoint: /health"
          echo ""
          
          echo "Waiting 15s for service to stabilize..."
          sleep 15
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/health" --connect-timeout 10 --max-time 30 || echo "000")
            
            if [ "$STATUS" = "200" ]; then
              echo ""
              echo "====================================="
              echo "  ‚úÖ SMOKE TEST PASSED (HTTP 200)   "
              echo "====================================="
              echo ""
              echo "Your service is live at:"
              echo "  $SERVICE_URL"
              echo ""
          echo "Endpoints:"
              echo "  Root: ${SERVICE_URL}/"
              echo "  Health: ${SERVICE_URL}/health"
              echo "  Version: ${SERVICE_URL}/version"
              echo "  API Docs: ${SERVICE_URL}/docs"
              exit 0
            fi
            
            echo "  Got HTTP $STATUS, retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done
          
          echo ""
          echo "====================================="
          echo "  ‚ùå SMOKE TEST FAILED               "
          echo "====================================="
          echo ""
          echo "Health check did not return HTTP 200 after $MAX_RETRIES attempts."
          echo "Last status: HTTP $STATUS"
          echo ""
          echo "Possible causes:"
          echo "  1. Service still starting (try again in a few minutes)"
          echo "  2. Missing environment variables in Cloud Run"
          echo "  3. Application crash on startup (check Cloud Run logs)"
          echo ""
          echo "To debug:"
          echo "  1. Go to: console.cloud.google.com ‚Üí Cloud Run ‚Üí ${{ env.CLOUD_RUN_SERVICE }}"
          echo "  2. Click the 'Logs' tab"
          echo "  3. Look for error messages"
          exit 1
